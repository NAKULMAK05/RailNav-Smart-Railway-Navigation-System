<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="description" content="Professional AR Railway Navigation" />
  <title>Railway Navigator</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* Global Styles */
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    :root {
      --primary: #1a73e8;
      --primary-light: #e8f0fe;
      --primary-dark: #0d47a1;
      --secondary: #ea4335;
      --accent: #fbbc04;
      --dark: #202124;
      --light: #ffffff;
      --gray: #70757a;
      --gray-light: #f1f3f4;
      --gray-dark: #5f6368;
      --shadow-sm: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
      --shadow-md: 0 2px 6px rgba(60, 64, 67, 0.3), 0 1px 2px rgba(60, 64, 67, 0.2);
      --shadow-lg: 0 4px 8px rgba(60, 64, 67, 0.3), 0 1px 3px rgba(60, 64, 67, 0.15);
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-full: 9999px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --font-sans: 'Roboto', sans-serif;
    }
    
    body { 
      font-family: var(--font-sans); 
      overflow: hidden; 
      background-color: var(--light); 
      height: 100vh; 
      display: flex; 
      flex-direction: column;
      color: var(--dark);
    }
    
    #map { 
      flex: 1; 
      width: 100%; 
      height: 100%;
      z-index: 1;
    }

    /* Top Search Bar */
    .search-bar {
      position: absolute; 
      top: 16px; 
      left: 16px; 
      right: 16px;
      background: var(--light); 
      border-radius: var(--radius-full);
      box-shadow: var(--shadow-md); 
      z-index: 1000;
      display: flex; 
      align-items: center; 
      height: 48px;
      max-width: 600px;
      margin: 0 auto;
      overflow: hidden;
    }
    
    .search-bar .back-btn {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: var(--gray-dark);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .search-bar .back-btn:hover {
      color: var(--primary);
      background-color: var(--primary-light);
    }
    
    .search-bar input {
      flex: 1; 
      height: 100%;
      padding: 0 16px; 
      border: none; 
      font-size: 16px; 
      outline: none;
      color: var(--dark);
      background: transparent;
    }
    
    .search-bar .voice-btn {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: var(--primary);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .search-bar .voice-btn:hover {
      background-color: var(--primary-light);
    }

    /* Map Controls */
    .map-controls {
      position: absolute;
      right: 16px;
      bottom: 200px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 900;
    }
    
    .map-control-btn {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      background: var(--light);
      border: none;
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray-dark);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .map-control-btn:hover {
      background-color: var(--gray-light);
      box-shadow: var(--shadow-md);
    }
    
    .map-control-btn.active {
      color: var(--primary);
      background-color: var(--primary-light);
    }

    /* Bottom Sheet */
    .bottom-sheet {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--light);
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateY(calc(100% - 120px));
      max-height: 70vh;
      overflow: hidden;
    }
    
    .bottom-sheet.expanded {
      transform: translateY(0);
    }
    
    .bottom-sheet-handle {
      width: 40px;
      height: 5px;
      background: var(--gray-light);
      border-radius: 3px;
      margin: 12px auto;
      cursor: pointer;
    }
    
    .bottom-sheet-content {
      padding: 0 16px 16px;
      overflow-y: auto;
      max-height: calc(70vh - 30px);
    }
    
    .route-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .route-info-main {
      display: flex;
      flex-direction: column;
    }
    
    .route-info-main h2 {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 4px;
      color: var(--dark);
    }
    
    .route-info-main p {
      font-size: 14px;
      color: var(--gray);
    }
    
    .route-info-time {
      text-align: right;
    }
    
    .route-info-time .time {
      font-size: 20px;
      font-weight: 500;
      color: var(--dark);
    }
    
    .route-info-time .eta {
      font-size: 14px;
      color: var(--gray);
    }
    
    .route-details {
      margin-top: 16px;
    }
    
    .route-step {
      display: flex;
      margin-bottom: 20px;
      position: relative;
    }
    
    .route-step:last-child {
      margin-bottom: 0;
    }
    
    .route-step-icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      background: var(--primary-light);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      margin-right: 16px;
      flex-shrink: 0;
      position: relative;
      z-index: 2;
    }
    
    .route-step-content {
      flex: 1;
    }
    
    .route-step-title {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 4px;
      color: var(--dark);
    }
    
    .route-step-subtitle {
      font-size: 14px;
      color: var(--gray);
    }
    
    .route-step-line {
      position: absolute;
      left: 16px;
      top: 32px;
      bottom: -20px;
      width: 2px;
      background: var(--primary-light);
      z-index: 1;
    }
    
    .route-step:last-child .route-step-line {
      display: none;
    }
    
    .action-buttons {
      display: flex;
      gap: 16px;
      margin-top: 24px;
    }
    
    .action-button {
      flex: 1;
      height: 48px;
      border-radius: var(--radius-md);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .action-button.primary {
      background: var(--primary);
      color: white;
    }
    
    .action-button.primary:hover {
      background: var(--primary-dark);
      box-shadow: var(--shadow-md);
    }
    
    .action-button.secondary {
      background: var(--primary-light);
      color: var(--primary);
    }
    
    .action-button.secondary:hover {
      background: #d4e4fc;
      box-shadow: var(--shadow-sm);
    }
    
    .action-button:disabled {
      background: var(--gray-light);
      color: var(--gray);
      cursor: not-allowed;
      box-shadow: none;
    }

    /* AR Container */
    #ar-container {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 0;
      background: #000; 
      z-index: 2000; 
      overflow: hidden; 
      transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    #ar-container.active { 
      height: 100%;
    }
    
    #video {
      width: 100%; 
      height: 100%; 
      object-fit: cover;
    }
    
    #ar-canvas {
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%;
      pointer-events: none; 
      z-index: 10;
    }
    
    .ar-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 20;
      pointer-events: none;
    }
    
    .ar-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      pointer-events: all;
    }
    
    .ar-close-btn {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      background: rgba(0, 0, 0, 0.5);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .ar-close-btn:hover {
      background: rgba(0, 0, 0, 0.7);
    }
    
    .ar-info {
      position: absolute;
      bottom: 24px;
      left: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: var(--shadow-md);
      pointer-events: all;
    }
    
    .ar-info-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .ar-info-header h3 {
      font-size: 18px;
      font-weight: 500;
      color: var(--dark);
    }
    
    .ar-distance {
      font-size: 16px;
      font-weight: 500;
      color: var(--primary);
    }
    
    .ar-next-step {
      font-size: 14px;
      color: var(--gray-dark);
      margin-bottom: 16px;
    }
    
    .ar-compass {
      position: absolute;
      top: 70px;
      right: 16px;
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
      pointer-events: all;
    }
    
    .compass-inner {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      border: 2px solid var(--primary);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .compass-needle {
      position: absolute;
      width: 2px;
      height: 20px;
      background: linear-gradient(to bottom, var(--primary) 50%, var(--secondary) 50%);
      transform-origin: center;
      transition: transform 0.3s ease;
    }
    
    .compass-marker {
      position: absolute;
      font-size: 10px;
      font-weight: 700;
    }
    
    .compass-marker.north {
      top: 2px;
    }
    
    .compass-marker.east {
      right: 2px;
    }
    
    .compass-marker.south {
      bottom: 2px;
    }
    
    .compass-marker.west {
      left: 2px;
    }

    /* Loading Indicator */
    .loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1500;
      background: rgba(255, 255, 255, 0.9);
      padding: 16px 24px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      display: none;
      align-items: center;
      gap: 16px;
    }
    
    .loading-indicator.active {
      display: flex;
    }
    
    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(26, 115, 232, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }
    
    .loading-text {
      font-size: 16px;
      font-weight: 500;
      color: var(--dark);
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--dark);
      color: white;
      padding: 12px 20px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      z-index: 2000;
      display: flex;
      align-items: center;
      gap: 12px;
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
      max-width: 90%;
    }
    
    .notification.active {
      opacity: 1;
    }
    
    .notification i {
      font-size: 20px;
    }
    
    .notification-message {
      font-size: 14px;
      font-weight: 400;
    }

    /* User Location Marker */
    .user-location-marker {
      background: transparent;
      border: none;
    }
    
    .user-location-dot {
      width: 16px;
      height: 16px;
      background: var(--primary);
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }
    
    .user-location-accuracy {
      width: 40px;
      height: 40px;
      background: rgba(26, 115, 232, 0.1);
      border: 1px solid rgba(26, 115, 232, 0.2);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% {
        transform: scale(0.8);
        opacity: 0.8;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.4;
      }
      100% {
        transform: scale(0.8);
        opacity: 0.8;
      }
    }

    /* Destination Marker */
    .destination-marker {
      background: transparent;
      border: none;
    }
    
    .destination-pin {
      width: 24px;
      height: 24px;
      background: var(--secondary);
      border: 2px solid white;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      box-shadow: var(--shadow-sm);
      position: relative;
    }
    
    .destination-pin::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
      .search-bar {
        top: 12px;
        left: 12px;
        right: 12px;
        height: 44px;
      }
      
      .map-controls {
        right: 12px;
        bottom: 180px;
      }
      
      .map-control-btn {
        width: 36px;
        height: 36px;
      }
      
      .bottom-sheet {
        transform: translateY(calc(100% - 100px));
      }
      
      .route-info-main h2 {
        font-size: 18px;
      }
      
      .route-info-time .time {
        font-size: 18px;
      }
      
      .action-button {
        height: 44px;
        font-size: 15px;
      }
    }
    
    @media (max-width: 480px) {
      .search-bar {
        top: 8px;
        left: 8px;
        right: 8px;
        height: 40px;
      }
      
      .search-bar .back-btn,
      .search-bar .voice-btn {
        width: 40px;
        height: 40px;
      }
      
      .map-controls {
        right: 8px;
        bottom: 160px;
      }
      
      .map-control-btn {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }
      
      .bottom-sheet {
        transform: translateY(calc(100% - 90px));
      }
      
      .bottom-sheet-handle {
        width: 36px;
        margin: 10px auto;
      }
      
      .route-info-main h2 {
        font-size: 16px;
      }
      
      .route-info-main p {
        font-size: 13px;
      }
      
      .route-info-time .time {
        font-size: 16px;
      }
      
      .route-info-time .eta {
        font-size: 13px;
      }
      
      .route-step-icon {
        width: 28px;
        height: 28px;
        margin-right: 12px;
      }
      
      .route-step-title {
        font-size: 15px;
      }
      
      .route-step-subtitle {
        font-size: 13px;
      }
      
      .action-buttons {
        gap: 12px;
      }
      
      .action-button {
        height: 40px;
        font-size: 14px;
      }
      
      .ar-info {
        padding: 12px;
      }
      
      .ar-info-header h3 {
        font-size: 16px;
      }
      
      .ar-compass {
        width: 50px;
        height: 50px;
      }
      
      .compass-inner {
        width: 34px;
        height: 34px;
      }
    }
  </style>
</head>
<body>
  <!-- Search Bar -->
  <div class="search-bar">
    <button id="back-btn" class="back-btn" style="display: none;">
      <i class="fas fa-arrow-left"></i>
    </button>
    <input type="text" id="search" placeholder="Search destination" aria-label="Search destination" />
    <button id="voice-search-btn" class="voice-btn">
      <i class="fas fa-microphone"></i>
    </button>
  </div>
  
  <!-- Map Container -->
  <div id="map"></div>
  
  <!-- Map Controls -->
  <div class="map-controls">
    <button id="zoom-in-btn" class="map-control-btn">
      <i class="fas fa-plus"></i>
    </button>
    <button id="zoom-out-btn" class="map-control-btn">
      <i class="fas fa-minus"></i>
    </button>
    <button id="locate-me-btn" class="map-control-btn">
      <i class="fas fa-location-crosshairs"></i>
    </button>
    <button id="layers-btn" class="map-control-btn">
      <i class="fas fa-layer-group"></i>
    </button>
  </div>
  
  <!-- Bottom Sheet -->
  <div id="bottom-sheet" class="bottom-sheet">
    <div id="bottom-sheet-handle" class="bottom-sheet-handle"></div>
    <div class="bottom-sheet-content">
      <div class="route-info">
        <div class="route-info-main">
          <h2>Navigation Details</h2>
          <p>Walking directions to destination</p>
        </div>
        <div class="route-info-time">
          <div class="time" id="route-time">--</div>
          <div class="eta" id="route-eta">ETA: --</div>
        </div>
      </div>
      
      <div class="route-details" id="route-details">
        <!-- Route steps will be inserted here dynamically -->
      </div>
      
      <div class="action-buttons">
        <button id="start-nav-btn" class="action-button primary">
          <i class="fas fa-directions"></i>
          <span>Start</span>
        </button>
        <button id="ar-btn" class="action-button secondary" disabled>
          <i class="fas fa-vr-cardboard"></i>
          <span>AR View</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- AR Container -->
  <div id="ar-container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="ar-canvas"></canvas>
    
    <div class="ar-overlay">
      <div class="ar-header">
        <button id="ar-close-btn" class="ar-close-btn">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="ar-compass" id="ar-compass">
        <div class="compass-inner">
          <div class="compass-needle" id="compass-needle"></div>
          <div class="compass-marker north">N</div>
          <div class="compass-marker east">E</div>
          <div class="compass-marker south">S</div>
          <div class="compass-marker west">W</div>
        </div>
      </div>
      
      <div class="ar-info">
        <div class="ar-info-header">
          <h3>Follow the arrow</h3>
          <div class="ar-distance" id="ar-distance">-- m</div>
        </div>
        <div class="ar-next-step" id="ar-next-step">--</div>
      </div>
    </div>
  </div>
  
  <!-- Loading Indicator -->
  <div id="loading-indicator" class="loading-indicator">
    <div class="loading-spinner"></div>
    <div class="loading-text">Finding the best route...</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script>
    /*********************
     * INITIALIZATION
     *********************/
    const map = L.map('map', { zoomControl: false }).setView([21.1522, 79.0888], 15);
    
    // Use a cleaner map style similar to Google Maps
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(map);

    // Global State Variables
    let userMarker = null;
    let userAccuracyCircle = null;
    let destinationMarker = null;
    let destinationLatLng = null;
    let routingControl = null;
    let isARModeEnabled = false;
    let arrowCanvas = document.getElementById('ar-canvas');
    let arrowContext = arrowCanvas.getContext('2d');
    let currentHeading = 0;
    let routeCoordinates = [];
    let instructions = [];
    let deviceOrientationListenerAdded = false;
    let bottomSheetExpanded = false;
    let mapLayersVisible = false;
    
    // DOM Elements
    const loadingIndicator = document.getElementById('loading-indicator');
    const bottomSheet = document.getElementById('bottom-sheet');
    const bottomSheetHandle = document.getElementById('bottom-sheet-handle');
    const routeDetails = document.getElementById('route-details');
    const arContainer = document.getElementById('ar-container');
    const compassNeedle = document.getElementById('compass-needle');

    // Create custom user location marker
    function createUserMarker(latlng) {
      const markerHtml = `
        <div class="user-location-marker">
          <div class="user-location-accuracy"></div>
          <div class="user-location-dot"></div>
        </div>
      `;
      
      const icon = L.divIcon({
        html: markerHtml,
        className: 'user-location-marker-container',
        iconSize: [40, 40],
        iconAnchor: [20, 20]
      });
      
      return L.marker(latlng, {
        icon: icon,
        zIndexOffset: 1000
      });
    }
    
    // Create custom destination marker
    function createDestinationMarker(latlng, title) {
      const markerHtml = `
        <div class="destination-marker">
          <div class="destination-pin"></div>
        </div>
      `;
      
      const icon = L.divIcon({
        html: markerHtml,
        className: 'destination-marker-container',
        iconSize: [24, 24],
        iconAnchor: [12, 24]
      });
      
      const marker = L.marker(latlng, {
        icon: icon,
        zIndexOffset: 900
      });
      
      if (title) {
        marker.  {
        icon: icon,
        zIndexOffset: 900
      });
      
      if (title) {
        marker.bindPopup(`<b>${title}</b>`, {
          offset: [0, -20],
          closeButton: false,
          className: 'destination-popup'
        });
      }
      
      return marker;
    }

    // Hardcoded Nagpur Central Station Data
    const customLocations = {
      "nagpur railway station platform 1": { lat: 21.15243, lng: 79.08837 },
      "nagpur railway station platform 2": { lat: 21.15230, lng: 79.08850 },
      "nagpur railway station platform 3": { lat: 21.15220, lng: 79.08863 },
      "nagpur railway station platform 4": { lat: 21.15218, lng: 79.08877 },
      "nagpur railway station platform 5": { lat: 21.15194, lng: 79.08878 },
      "nagpur railway station platform 6": { lat: 21.15185, lng: 79.08890 },
      "nagpur railway station platform 7": { lat: 21.15175, lng: 79.08900 },
      "nagpur railway station platform 8": { lat: 21.15165, lng: 79.08910 },
      "nagpur railway station atm": { lat: 21.15157, lng: 79.08815 },
      "nagpur railway station foodcourt": { lat: 21.15184, lng: 79.08856 },
      "nagpur railway station restroom": { lat: 21.15247, lng: 79.08842 },
      "nagpur railway station waiting area": { lat: 21.15210, lng: 79.08830 },
      "nagpur railway station ticket counter": { lat: 21.15235, lng: 79.08820 },
      "nagpur railway station entrance": { lat: 21.15260, lng: 79.08860 }
    };

    /*********************
     * GEOLOCATION FUNCTIONS
     *********************/
    function getUserLocation(callback) {
      showLoading('Getting your location...');
      
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userLatLng = L.latLng(position.coords.latitude, position.coords.longitude);
            const accuracy = position.coords.accuracy;
            
            if (!userMarker) {
              userMarker = createUserMarker(userLatLng).addTo(map);
              
              // Add accuracy circle
              userAccuracyCircle = L.circle(userLatLng, {
                radius: accuracy,
                color: 'rgba(26, 115, 232, 0.2)',
                fillColor: 'rgba(26, 115, 232, 0.1)',
                fillOpacity: 0.4,
                weight: 1
              }).addTo(map);
            } else {
              userMarker.setLatLng(userLatLng);
              userAccuracyCircle.setLatLng(userLatLng);
              userAccuracyCircle.setRadius(accuracy);
            }
            
            map.panTo(userLatLng, { animate: true });
            hideLoading();
            
            if (callback) callback(userLatLng);
          },
          (error) => {
            hideLoading();
            console.error('Geolocation error:', error);
            
            let errorMsg = 'Unable to retrieve your location.';
            if (error.code === 1) {
              errorMsg = 'Location access denied. Please enable location services.';
            } else if (error.code === 2) {
              errorMsg = 'Location unavailable. Please try again.';
            } else if (error.code === 3) {
              errorMsg = 'Location request timed out. Please try again.';
            }
            
            showNotification(errorMsg, 'error');
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      } else {
        hideLoading();
        showNotification('Geolocation is not supported by your browser.', 'error');
      }
    }

    function watchUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (position) => {
            const userLatLng = L.latLng(position.coords.latitude, position.coords.longitude);
            const accuracy = position.coords.accuracy;
            
            if (userMarker) {
              userMarker.setLatLng(userLatLng);
              userAccuracyCircle.setLatLng(userLatLng);
              userAccuracyCircle.setRadius(accuracy);
            }
            
            if (destinationLatLng && routingControl) {
              updateNavigationInfo(userLatLng);
            }
          },
          (error) => {
            console.error('Location watch failed:', error);
          },
          { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
        );
      }
    }

    /*********************
     * ROUTING & NAVIGATION
     *********************/
    function updateRoute(userLatLng, retryCount = 0) {
      showLoading('Finding the best route...');
      
      if (routingControl) map.removeControl(routingControl);
      
      routingControl = L.Routing.control({
        waypoints: [userLatLng, destinationLatLng],
        routeWhileDragging: false,
        lineOptions: { 
          styles: [{ 
            color: '#1a73e8', 
            weight: 5, 
            opacity: 0.7,
            lineCap: 'round',
            lineJoin: 'round'
          }],
          extendToWaypoints: true,
          missingRouteTolerance: 0
        },
        show: false, // Hide the default instructions panel
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        showAlternatives: false,
        createMarker: function() { return null; }, // We'll create our own markers
        router: L.Routing.osrmv1({ 
          serviceUrl: 'https://router.project-osrm.org/route/v1',
          profile: 'foot' // Use walking profile
        })
      })
      .on('routesfound', (e) => {
        const routes = e.routes[0];
        routeCoordinates = routes.coordinates;
        instructions = routes.instructions;
        
        updateNavigationInfo(userLatLng);
        renderRouteDetails(routes);
        
        // Show the bottom sheet
        bottomSheet.style.display = 'block';
        
        // Enable AR button
        document.getElementById('ar-btn').disabled = false;
        
        // Show back button
        document.getElementById('back-btn').style.display = 'block';
        
        hideLoading();
      })
      .on('routingerror', (e) => {
        console.error('Routing error:', e);
        hideLoading();
        
        if (retryCount < 3) {
          setTimeout(() => updateRoute(userLatLng, retryCount + 1), 1000);
        } else {
          showNotification('Failed to calculate route. Please try again.', 'error');
        }
      })
      .addTo(map);
    }

    function updateNavigationInfo(userLatLng) {
      if (!routeCoordinates.length || !routingControl._routes?.[0]?.summary) return;
      
      const totalDistance = userLatLng.distanceTo(destinationLatLng);
      const totalTime = routingControl._routes[0].summary.totalTime;
      
      // Format time (minutes and seconds)
      let timeText;
      if (totalTime < 60) {
        timeText = `${Math.round(totalTime)} sec`;
      } else {
        const minutes = Math.floor(totalTime / 60);
        timeText = `${minutes} min`;
      }
      
      // Format ETA
      const eta = new Date(Date.now() + totalTime * 1000).toLocaleTimeString([], { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      // Find next instruction
      const nextInstruction = instructions.find(instr => {
        const point = routeCoordinates[instr.index];
        return L.latLng(point.lat, point.lng).distanceTo(userLatLng) > 5;
      }) || { text: 'Arrived at destination' };

      // Update bottom sheet
      document.getElementById('route-time').innerHTML = timeText;
      document.getElementById('route-eta').innerHTML = `ETA: ${eta}`;
      
      // Update AR view if active
      if (isARModeEnabled) {
        document.getElementById('ar-distance').innerHTML = totalDistance < 1000 ? 
          `${Math.round(totalDistance)} m` : 
          `${(totalDistance / 1000).toFixed(2)} km`;
        document.getElementById('ar-next-step').innerHTML = nextInstruction.text;
      }
    }

    function renderRouteDetails(route) {
      routeDetails.innerHTML = '';
      
      if (!route.instructions || route.instructions.length === 0) {
        return;
      }
      
      // Create route steps
      route.instructions.forEach((instruction, index) => {
        const stepElement = document.createElement('div');
        stepElement.className = 'route-step';
        
        // Determine icon based on instruction type
        let iconClass = 'fa-arrow-right';
        if (instruction.type === 'Straight') iconClass = 'fa-arrow-up';
        else if (instruction.type === 'SlightRight') iconClass = 'fa-arrow-up-right';
        else if (instruction.type === 'Right') iconClass = 'fa-arrow-right';
        else if (instruction.type === 'SharpRight') iconClass = 'fa-arrow-right';
        else if (instruction.type === 'SlightLeft') iconClass = 'fa-arrow-up-left';
        else if (instruction.type === 'Left') iconClass = 'fa-arrow-left';
        else if (instruction.type === 'SharpLeft') iconClass = 'fa-arrow-left';
        else if (instruction.type === 'Uturn') iconClass = 'fa-arrow-turn-up';
        else if (instruction.type === 'Roundabout') iconClass = 'fa-rotate-right';
        else if (instruction.type === 'DestinationReached') iconClass = 'fa-location-dot';
        
        // Format distance
        let distanceText = '';
        if (instruction.distance) {
          if (instruction.distance < 1000) {
            distanceText = `${Math.round(instruction.distance)} m`;
          } else {
            distanceText = `${(instruction.distance / 1000).toFixed(2)} km`;
          }
        }
        
        stepElement.innerHTML = `
          <div class="route-step-icon">
            <i class="fas ${iconClass}"></i>
          </div>
          <div class="route-step-line"></div>
          <div class="route-step-content">
            <div class="route-step-title">${instruction.text}</div>
            <div class="route-step-subtitle">${distanceText}</div>
          </div>
        `;
        
        routeDetails.appendChild(stepElement);
      });
    }

    /*********************
     * SEARCH & VOICE HANDLING
     *********************/
    function processSearch(query) {
      query = query.toLowerCase().trim();
      
      if (!query) {
        showNotification('Please enter a destination.', 'warning');
        return;
      }
      
      showLoading('Searching for location...');
      
      if (customLocations[query]) {
        destinationLatLng = L.latLng(customLocations[query].lat, customLocations[query].lng);
        
        // Clear previous destination marker
        if (destinationMarker) {
          map.removeLayer(destinationMarker);
        }
        
        // Add destination marker
        destinationMarker = createDestinationMarker(destinationLatLng, query).addTo(map);
        
        getUserLocation((userLatLng) => updateRoute(userLatLng));
        hideLoading();
      } else {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`)
          .then(res => res.json())
          .then(data => {
            hideLoading();
            
            if (data.length) {
              destinationLatLng = L.latLng(parseFloat(data[0].lat), parseFloat(data[0].lon));
              
              // Clear previous destination marker
              if (destinationMarker) {
                map.removeLayer(destinationMarker);
              }
              
              // Add destination marker
              destinationMarker = createDestinationMarker(destinationLatLng, data[0].display_name).addTo(map);
              
              getUserLocation((userLatLng) => updateRoute(userLatLng));
            } else {
              showNotification('Location not found! Please try a different search term.', 'warning');
            }
          })
          .catch(err => {
            hideLoading();
            console.error('Search error:', err);
            showNotification('Search failed. Please check your connection and try again.', 'error');
          });
      }
    }

    /*********************
     * UI HELPERS
     *********************/
    function showLoading(message) {
      const loadingText = document.querySelector('.loading-text');
      if (loadingText) {
        loadingText.textContent = message || 'Loading...';
      }
      loadingIndicator.classList.add('active');
    }
    
    function hideLoading() {
      loadingIndicator.classList.remove('active');
    }
    
    function showNotification(message, type = 'info') {
      // Remove any existing notification
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
        document.body.removeChild(existingNotification);
      }
      
      // Create new notification
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      let icon = 'fa-info-circle';
      if (type === 'error') icon = 'fa-exclamation-circle';
      else if (type === 'warning') icon = 'fa-exclamation-triangle';
      else if (type === 'success') icon = 'fa-check-circle';
      
      notification.innerHTML = `
        <i class="fas ${icon}"></i>
        <span class="notification-message">${message}</span>
      `;
      
      document.body.appendChild(notification);
      
      // Show notification with animation
      setTimeout(() => {
        notification.classList.add('active');
      }, 10);
      
      // Auto hide after 4 seconds
      setTimeout(() => {
        notification.classList.remove('active');
        
        setTimeout(() => {
          if (notification.parentNode) {
            document.body.removeChild(notification);
          }
        }, 300);
      }, 4000);
    }

    /*********************
     * AR NAVIGATION
     *********************/
    function startAR() {
      showLoading('Starting AR mode...');
      
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then((stream) => {
          const video = document.getElementById('video');
          video.srcObject = stream;
          video.play();
          
          video.addEventListener('loadeddata', () => {
            arrowCanvas.width = video.videoWidth;
            arrowCanvas.height = video.videoHeight;
            
            const updateFrame = () => {
              if (isARModeEnabled) updateAR(currentHeading);
              requestAnimationFrame(updateFrame);
            };
            
            updateFrame();
            hideLoading();
          });
        })
        .catch((err) => {
          hideLoading();
          console.error('Error accessing camera:', err);
          showNotification('Camera access failed. Please allow camera permissions.', 'error');
          arContainer.classList.remove('active');
          isARModeEnabled = false;
          document.getElementById('ar-btn').disabled = false;
        });

      if (!deviceOrientationListenerAdded) {
        // Request permission for iOS devices
        if (typeof DeviceOrientationEvent !== 'undefined' && 
            typeof DeviceOrientationEvent.requestPermission === 'function') {
          
          DeviceOrientationEvent.requestPermission()
            .then(permissionState => {
              if (permissionState === 'granted') {
                window.addEventListener('deviceorientation', handleOrientation, true);
              } else {
                showNotification('Orientation access denied. AR navigation may not work correctly.', 'warning');
              }
            })
            .catch(console.error);
        } else {
          window.addEventListener('deviceorientation', handleOrientation, true);
        }
        
        deviceOrientationListenerAdded = true;
      }
    }

    function handleOrientation(event) {
      currentHeading = event.alpha || 0;
      
      // Update compass
      if (compassNeedle) {
        compassNeedle.style.transform = `rotate(${currentHeading}deg)`;
      }
      
      if (destinationLatLng && isARModeEnabled) {
        updateAR(currentHeading);
      }
    }

    function updateAR(compassHeading) {
      if (!destinationLatLng || !userMarker) return;
      
      const userLatLng = userMarker.getLatLng();
      const destinationHeading = calculateHeading(userLatLng, destinationLatLng);
      const arrowRotation = (compassHeading - destinationHeading + 360) % 360;
      
      // Clear canvas
      arrowContext.clearRect(0, 0, arrowCanvas.width, arrowCanvas.height);
      
      // Draw arrow
      drawGoogleStyleArrow(
        arrowContext, 
        arrowCanvas.width / 2, 
        arrowCanvas.height / 2, 
        arrowRotation,
        userLatLng.distanceTo(destinationLatLng)
      );
    }

    function drawGoogleStyleArrow(ctx, x, y, rotation, distance) {
      const canvasWidth = ctx.canvas.width;
      const canvasHeight = ctx.canvas.height;
      
      // Calculate arrow size based on canvas dimensions
      const arrowSize = Math.min(canvasWidth, canvasHeight) * 0.25;
      
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(rotation * Math.PI / 180);
      
      // Draw arrow shadow
      ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
      ctx.shadowBlur = 15;
      ctx.shadowOffsetY = 5;
      
      // Draw arrow body
      const gradient = ctx.createLinearGradient(0, -arrowSize, 0, arrowSize/2);
      gradient.addColorStop(0, '#1a73e8');
      gradient.addColorStop(1, '#4285f4');
      
      ctx.beginPath();
      
      // Arrow shape - Google Maps style
      const arrowWidth = arrowSize * 0.5;
      
      // Arrow head
      ctx.moveTo(0, -arrowSize);
      ctx.lineTo(arrowWidth, 0);
      ctx.lineTo(arrowWidth/2, 0);
      ctx.lineTo(arrowWidth/2, arrowSize/2);
      ctx.lineTo(-arrowWidth/2, arrowSize/2);
      ctx.lineTo(-arrowWidth/2, 0);
      ctx.lineTo(-arrowWidth, 0);
      
      ctx.closePath();
      ctx.fillStyle = gradient;
      ctx.fill();
      
      // Add a highlight effect
      ctx.beginPath();
      ctx.moveTo(0, -arrowSize + 5);
      ctx.lineTo(arrowWidth - 5, 0);
      ctx.lineTo(0, -arrowSize/2);
      ctx.lineTo(-arrowWidth + 5, 0);
      ctx.closePath();
      ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
      ctx.fill();
      
      // Draw distance indicator if we're close enough
      if (distance < 200) {
        ctx.shadowColor = 'transparent';
        ctx.fillStyle = 'white';
        ctx.font = 'bold 24px Roboto, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(`${Math.round(distance)}m`, 0, arrowSize + 40);
      }
      
      ctx.restore();
      
      // Draw pulsing circle at the bottom if we're very close
      if (distance < 50) {
        const now = Date.now() / 1000;
        const scale = 0.5 + Math.sin(now * 3) * 0.2;
        
        ctx.save();
        ctx.translate(x, y);
        
        ctx.beginPath();
        ctx.arc(0, 0, 30 * scale, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(26, 115, 232, 0.3)';
        ctx.fill();
        
        ctx.beginPath();
        ctx.arc(0, 0, 15 * scale, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(26, 115, 232, 0.6)';
        ctx.fill();
        
        ctx.restore();
      }
    }

    function calculateHeading(from, to) {
      const lat1 = from.lat * Math.PI / 180;
      const lat2 = to.lat * Math.PI / 180;
      const dLon = (to.lng - from.lng) * Math.PI / 180;
      const y = Math.sin(dLon) * Math.cos(lat2);
      const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
      const heading = Math.atan2(y, x) * 180 / Math.PI;
      return (heading + 360) % 360;
    }

    /*********************
     * EVENT LISTENERS
     *********************/
    // Search input
    document.getElementById('search').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        processSearch(e.target.value);
      }
    });

    // Voice search
    document.getElementById('voice-search-btn').addEventListener('click', () => {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      
      if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        
        // Show listening indicator
        const searchInput = document.getElementById('search');
        const originalPlaceholder = searchInput.placeholder;
        searchInput.placeholder = 'Listening...';
        document.getElementById('voice-search-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          searchInput.value = transcript;
          searchInput.placeholder = originalPlaceholder;
          document.getElementById('voice-search-btn').innerHTML = '<i class="fas fa-microphone"></i>';
          processSearch(transcript);
        };
        
        recognition.onerror = (event) => {
          console.error('Voice recognition error:', event.error);
          searchInput.placeholder = originalPlaceholder;
          document.getElementById('voice-search-btn').innerHTML = '<i class="fas fa-microphone"></i>';
          showNotification('Voice recognition failed. Please try again or type your search.', 'warning');
        };
        
        recognition.onend = () => {
          searchInput.placeholder = originalPlaceholder;
          document.getElementById('voice-search-btn').innerHTML = '<i class="fas fa-microphone"></i>';
        };
        
        recognition.start();
      } else {
        showNotification('Voice search is not supported in your browser.', 'warning');
      }
    });

    // Start navigation
    document.getElementById('start-nav-btn').addEventListener('click', () => {
      getUserLocation((userLatLng) => {
        if (destinationLatLng) {
          updateRoute(userLatLng);
          document.getElementById('back-btn').style.display = 'block';
        } else {
          showNotification('Please select a destination first!', 'warning');
        }
      });
    });

    // Back button
    document.getElementById('back-btn').addEventListener('click', () => {
      // Reset navigation
      if (routingControl) map.removeControl(routingControl);
      document.getElementById('back-btn').style.display = 'none';
      document.getElementById('ar-btn').disabled = true;
      
      // Hide bottom sheet
      bottomSheet.style.display = 'none';
      bottomSheet.classList.remove('expanded');
      bottomSheetExpanded = false;
      
      // Clear AR mode
      if (isARModeEnabled) {
        arContainer.classList.remove('active');
        isARModeEnabled = false;
        
        // Stop video tracks
        const videoElem = document.getElementById('video');
        if (videoElem.srcObject) {
          videoElem.srcObject.getTracks().forEach(track => track.stop());
        }
      }
      
      // Clear destination
      if (destinationMarker) {
        map.removeLayer(destinationMarker);
        destinationMarker = null;
      }
      
      destinationLatLng = null;
      routeCoordinates = [];
      instructions = [];
      
      // Clear search
      document.getElementById('search').value = '';
    });

    // AR mode
    document.getElementById('ar-btn').addEventListener('click', () => {
      if (!isARModeEnabled) {
        isARModeEnabled = true;
        arContainer.classList.add('active');
        document.getElementById('ar-btn').disabled = true;
        startAR();
      }
    });

    // Close AR
    document.getElementById('ar-close-btn').addEventListener('click', () => {
      arContainer.classList.remove('active');
      isARModeEnabled = false;
      document.getElementById('ar-btn').disabled = false;
      
      // Stop video tracks
      const videoElem = document.getElementById('video');
      if (videoElem.srcObject) {
        videoElem.srcObject.getTracks().forEach(track => track.stop());
      }
    });

    // Bottom sheet toggle
    bottomSheetHandle.addEventListener('click', () => {
      bottomSheetExpanded = !bottomSheetExpanded;
      bottomSheet.classList.toggle('expanded', bottomSheetExpanded);
    });

    // Map controls
    document.getElementById('zoom-in-btn').addEventListener('click', () => {
      map.zoomIn();
    });
    
    document.getElementById('zoom-out-btn').addEventListener('click', () => {
      map.zoomOut();
    });
    
    document.getElementById('locate-me-btn').addEventListener('click', () => {
      getUserLocation();
    });
    
    document.getElementById('layers-btn').addEventListener('click', () => {
      mapLayersVisible = !mapLayersVisible;
      document.getElementById('layers-btn').classList.toggle('active', mapLayersVisible);
      
      // In a real app, this would show a layers panel
      showNotification('Map layers feature coming soon!', 'info');
    });

    /*********************
     * INITIALIZE APP
     *********************/
    // Get user location on startup
    getUserLocation();
    
    // Start watching user location
    watchUserLocation();
  </script>
</body>
</html>
