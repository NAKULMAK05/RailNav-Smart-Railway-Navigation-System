<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Navigation with Professional 3D Arrow</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />
  <style>
    /* Routing Container */
    .leaflet-routing-container {
      background-color: #ffffff;
      border: 2px solid #007BFF;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      width: 300px;
      color: #000;
      padding: 15px;
      z-index: 1000;
    }

    .leaflet-routing-alternatives-container {
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
    }

    .leaflet-routing-container h3 {
      color: #007BFF;
      margin: 0 0 10px;
      font-size: 16px;
      font-family: 'Arial', sans-serif;
    }

    .leaflet-routing-alt {
      padding: 10px;
      background-color: #e9ecef;
      margin-bottom: 5px;
      border-radius: 5px;
    }

    .leaflet-routing-instructions p {
      margin: 5px 0;
      font-size: 14px;
      color: #333;
    }

    .leaflet-top.leaflet-right .leaflet-routing-container {
      margin-top: 60px;
    }

    /* General Styles */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    #search-bar-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      width: calc(100% - 20px);
      max-width: 400px;
      padding: 15px;
      background: rgba(40, 40, 55, 0.9);
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
    }

    #search-bar-container input {
      width: calc(100% - 20px);
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: none;
      background-color: #2d2d3b;
      color: #ffffff;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
    }

    #info {
      font-size: 15px;
      color: #dddddd;
    }

    #info p {
      margin: 5px 0;
    }

    #ar-container {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 400px;
      height: 300px;
      z-index: 2000;
      border: 3px solid #fff;
      border-radius: 10px;
      overflow: hidden;
      background: #000;
      display: none;
    }

    #ar-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #ar-container canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
    }

    #enable-ar-btn {
      position: absolute;
      right: 10px;
      bottom: 10px;
      z-index: 1001;
      padding: 10px 20px;
      background-color: #ff5555;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }

    #enable-ar-btn:hover {
      background-color: #e64444;
    }
  </style>
</head>

<body>
  <div id="search-bar-container">
    <input type="text" id="search" placeholder="Search for a place or facility" />
    <div id="info">
      <p>Distance: <span id="distance">--</span></p>
      <p>Time: <span id="time">--</span></p>
    </div>
  </div>
  <div id="map"></div>
  <button id="enable-ar-btn">Enable AR Navigation</button>
  <div id="ar-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="ar-canvas"></canvas>
  </div>

  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <script>
    // Default Location (Nagpur Central Station as fallback)
    const defaultLatLng = [21.1522, 79.0888];
    var map = L.map('map').setView(defaultLatLng, 15);
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: 'Leaflet Â© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);

    var userMarker = L.marker(defaultLatLng).addTo(map);
    var destinationLatLng = null;
    var routingControl = null;
    var isARModeEnabled = false;
    var arrowCanvas = document.getElementById('ar-canvas');
    var arrowContext = arrowCanvas.getContext('2d');
    var currentHeading = 0;
    var routeCoordinates = [];

    // Hardcoded Nagpur Central Station Facilities and Platforms
    const customLocations = {
      "nagpur railway station platform 1": { lat: 21.15243, lng: 79.08837 },
      "nagpur railway station platform 2": { lat: 21.15230, lng: 79.08850 },
      "nagpur railway station platform 3": { lat: 21.15220, lng: 79.08863 },
      "nagpur railway station platform 4": { lat: 21.15218, lng: 79.08877 },
      "nagpur railway station platform 5": { lat: 21.15194, lng: 79.08878 },
      "nagpur railway station platform 6": { lat: 21.15185, lng: 79.08890 },
      "nagpur railway station platform 7": { lat: 21.15175, lng: 79.08900 },
      "nagpur railway station platform 8": { lat: 21.15165, lng: 79.08910 },
      "nagpur railway station atm": { lat: 21.15157, lng: 79.08815 },
      "nagpur railway station foodcourt": { lat: 21.15184, lng: 79.08856 },
      "nagpur railway station restroom": { lat: 21.15247, lng: 79.08842 },
      "nagpur railway station waiting area": { lat: 21.15210, lng: 79.08830 },
      "nagpur railway station ticket counter": { lat: 21.15235, lng: 79.08820 },
      "nagpur railway station entrance": { lat: 21.15260, lng: 79.08860 }
    };

    // Watch User Location and Update Map
    function watchUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const userLatLng = L.latLng(lat, lng);

            userMarker.setLatLng(userLatLng);
            map.panTo(userLatLng); // Smoothly follow user

            if (destinationLatLng) {
              updateRoute(userLatLng);
            }
          },
          () => {
            alert('Unable to retrieve your location.');
          },
          { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
        );
      } else {
        alert('Geolocation is not supported by this browser.');
      }
    }

    // Update Route Dynamically
    function updateRoute(userLatLng) {
      if (routingControl) {
        map.removeControl(routingControl);
      }

      routingControl = L.Routing.control({
        waypoints: [userLatLng, L.latLng(destinationLatLng.lat, destinationLatLng.lng)],
        routeWhileDragging: true,
        lineOptions: { styles: [{ color: '#007BFF', weight: 4 }] },
        show: true,
        createMarker: () => null // Use existing markers
      }).on('routesfound', (e) => {
        const routes = e.routes;
        const summary = routes[0].summary;
        routeCoordinates = routes[0].coordinates; // Store route points for AR
        document.getElementById('distance').innerHTML = `${(summary.totalDistance / 1000).toFixed(2)} km`;
        document.getElementById('time').innerHTML = `${(summary.totalTime / 60).toFixed(2)} minutes`;

        if (isARModeEnabled) {
          updateAR(currentHeading);
        }
      }).addTo(map);
    }

    // Handle Search and Routing
    document.getElementById('search').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const query = document.getElementById('search').value.toLowerCase().trim();

        if (customLocations[query]) {
          destinationLatLng = L.latLng(customLocations[query].lat, customLocations[query].lng);
          L.marker(destinationLatLng).addTo(map).bindPopup(query).openPopup();
          updateRoute(userMarker.getLatLng());
        } else {
          fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
            .then((response) => response.json())
            .then((data) => {
              if (data && data.length > 0) {
                destinationLatLng = L.latLng(parseFloat(data[0].lat), parseFloat(data[0].lon));
                L.marker(destinationLatLng).addTo(map).bindPopup(query).openPopup();
                updateRoute(userMarker.getLatLng());
              } else {
                alert('Location not found!');
              }
            })
            .catch((error) => console.error('Error:', error));
        }
      }
    });

    // Enable AR Mode
    document.getElementById('enable-ar-btn').addEventListener('click', () => {
      if (!isARModeEnabled && destinationLatLng) {
        isARModeEnabled = true;
        document.getElementById('ar-container').style.display = 'block';
        document.getElementById('enable-ar-btn').disabled = true;
        startAR();
      } else if (!destinationLatLng) {
        alert('Please select a destination first!');
      }
    });

    // Start AR
    function startAR() {
      const video = document.getElementById('video');
      video.style.display = 'block';
      arrowCanvas.style.display = 'block';

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then((stream) => {
          video.srcObject = stream;
          video.play();

          video.addEventListener('loadeddata', () => {
            arrowCanvas.width = video.videoWidth;
            arrowCanvas.height = video.videoHeight;
            const updateFrame = () => {
              updateAR(currentHeading);
              requestAnimationFrame(updateFrame);
            };
            updateFrame();
          });
        })
        .catch((error) => {
          console.error('Error accessing camera:', error);
          alert('Camera access denied or unavailable.');
        });

      window.addEventListener('deviceorientation', (event) => {
        currentHeading = event.alpha || 0; // Fallback to 0 if alpha is null
        if (destinationLatLng && isARModeEnabled) {
          updateAR(currentHeading);
        }
      });
    }

    // Update AR with Route-Based Direction
    function updateAR(compassHeading) {
      if (!destinationLatLng || !routeCoordinates.length) return;

      const userLatLng = userMarker.getLatLng();
      const nextPoint = routeCoordinates.find((coord) => {
        const dist = L.latLng(coord.lat, coord.lng).distanceTo(userLatLng);
        return dist > 5; // Find the next point > 5m away
      }) || destinationLatLng; // Fallback to destination

      const destinationHeading = calculateHeading(userLatLng, nextPoint);
      const arrowRotation = (compassHeading - destinationHeading + 360) % 360;

      arrowContext.clearRect(0, 0, arrowCanvas.width, arrowCanvas.height);
      drawArrow(arrowContext, arrowCanvas.width / 2, arrowCanvas.height / 2, arrowRotation);
    }

    // Draw 3D Arrow
    function drawArrow(ctx, x, y, rotation) {
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(rotation * Math.PI / 180);

      ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
      ctx.shadowBlur = 10;
      ctx.shadowOffsetX = 12;
      ctx.shadowOffsetY = 8;

      ctx.beginPath();
      ctx.moveTo(-20, -70);
      ctx.lineTo(20, -70);
      ctx.lineTo(20, 0);
      ctx.lineTo(40, 0);
      ctx.lineTo(0, 100);
      ctx.lineTo(-40, 0);
      ctx.lineTo(-20, 0);
      ctx.lineTo(-20, -70);
      ctx.closePath();

      ctx.fillStyle = '#007BFF';
      ctx.fill();
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.restore();
    }

    // Calculate Heading
    function calculateHeading(from, to) {
      const lat1 = from.lat * Math.PI / 180;
      const lat2 = to.lat * Math.PI / 180;
      const dLon = (to.lng - from.lng) * Math.PI / 180;
      const y = Math.sin(dLon) * Math.cos(lat2);
      const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
      const heading = Math.atan2(y, x) * 180 / Math.PI;
      return (heading + 360) % 360;
    }

    // Start Watching User Location
    watchUserLocation();
  </script>
</body>

</html>
